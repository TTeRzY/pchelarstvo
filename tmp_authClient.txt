// Р•РґРёРЅРµРЅ РёРЅС‚РµСЂС„РµР№СЃ Р·Р° СЃРјСЏРЅР° РЅР° Р±РµРєРµРЅРґ (mock СЃРµРіР°, Laravel РїРѕСЃР»Рµ)
export type User = { id: string; name: string; email: string };
export type AuthResponse = { user: User; token?: string };

const API_BASE = process.env.NEXT_PUBLIC_API_BASE ?? ""; // РЅР°РїСЂ. https://api.pchelarstvo.bg

async function post<T>(url: string, body: any, token?: string): Promise<T> {
  const res = await fetch(`${API_BASE}${url}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
    },
    body: JSON.stringify(body),
    // Р’ РїСЂРѕРґСѓРєС†РёСЏ СЃ Laravel Sanctum С‰Рµ СЂР°Р±РѕС‚РёРј СЃ httpOnly cookie (Р±РµР· Authorization)
    credentials: "include",
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json() as Promise<T>;
}

// MOCK СЂРµР¶РёРј Р·Р° DEV: СЃСЉС…СЂР°РЅСЏРІР°РјРµ token РІ localStorage.
// РџСЂРё Laravel Sanctum С‰Рµ РјР°С…РЅРµРј localStorage Рё С‰Рµ СЂР°Р·С‡РёС‚Р°РјРµ РЅР° httpOnly cookies.
export const authStorage = {
  getToken: () => (typeof window !== "undefined" ? localStorage.getItem("token") : null),
  setToken: (t: string | null) => { if (typeof window !== "undefined") t ? localStorage.setItem("token", t) : localStorage.removeItem("token"); },
};

export const authClient = {
  async login(email: string, password: string): Promise<AuthResponse> {
    // MOCK: РІСЉСЂРЅРё С„РёРєС‚РёРІРµРЅ РїРѕС‚СЂРµР±РёС‚РµР» (Р·Р°РјРµРЅРё СЃ post<AuthResponse>("/api/login", { email, password }))
    const mock: AuthResponse = {
      user: { id: "1", name: "РњР°СЂРёРЅ", email },
      token: "dev-mock-token",
    };
    authStorage.setToken(mock.token ?? null);
    return mock;
  },
  async register(name: string, email: string, password: string): Promise<AuthResponse> {
    const mock: AuthResponse = {
      user: { id: "2", name, email },
      token: "dev-mock-token",
    };
    authStorage.setToken(mock.token ?? null);
    return mock;
    // Laravel: return post<AuthResponse>("/api/register", { name, email, password })
  },
  async logout(): Promise<void> {
    authStorage.setToken(null);
    // Laravel: await post("/api/logout", {})
  },
  async me(): Promise<User | null> {
    const token = authStorage.getToken();
    if (!token) return null;
    // Laravel: const data = await fetch(`${API_BASE}/api/me`, { credentials: "include" }).then(r=>r.json())
    return { id: "1", name: "РњР°СЂРёРЅ", email: "marin@example.com" };
  },
};
